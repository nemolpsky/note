>## 一、类文件结构简述
众所周知Java虚拟机是通过执行编译生成的```Class```文件来运行Java代码的，所以Java才支持所谓的"一次编写，到处运行（Write Once，Run Anywhere）"，因为只需要在不同平台安装Java虚拟机来执行```Class```文件即可，只要是满足规范的```Class```文件虚拟机就可以运行，也因此不止是Java语言，一些其它的语言，例如Kotlin、Clojure、Groovy、JRuby、JPython、Scala也可以生成```Class```文件在Java虚拟机上运行，因为对虚拟机来说，只要```Class```文件符合规范就可以运行，根本无需关心生成```Class```文件的是什么语言。

也正因为如此，```Class```文件其实有着非常严格的规范，生成的```Class```文件必须符合这个规范才可以在Java虚拟机上运行。


---


>## 二、Class类文件结构

### 1. 数据结构
上面说了```Class```文件有着严格的格式规范，规范来自于《Java虚拟机规范》中，所以自然有着它自己的语法，因此在```Class```文件中使用了两种数据类型，"无符号数"和"表"。

- 无符号数属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。
- 表是由多个无符号数或者其他表作为数据项构成的复合数据类型，为了便于区分，所有表的命名都习惯性地以```_info```结尾。表用于描述有层次关系的复合结构的数据，整个```Class```文件本质上也可以视作是一张表。

```Class```文件是一组以8个字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在文件之中，中间没有添加任何分隔符。

---

### 2. Class文件格式
下面这张图就是```Class```文件的格式，看上去有很多无符号数和表，其实理解为一个XML文件中的各种标签即可，不同的无符号数和表有着不同的作用，每个无符号数和表都有不同的值，不同的值则代表不同的含义属性。

![Class](https://github.com/nemolpsky/note/raw/master/file/file/java_plus/java_class/1.png)

从上到下依次顺序分别是：
- 魔数

  占4个字节，作用是确定文件是否是一个```Class```文件，固定值是```0xCAFEBABE```
- 次版本号

  占2个字节
- 主版本号

  占2个字节
- 常量池入口

  这是一个表类型的数据，由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一项u2类型的数据，代表常量池容量计数值（constant_pool_count），假如常量池容量为十六进制数```0x0016```，即十进制的22，这就代表常量池中有21项常量，索引值范围为1～21。

  常量池中主要存放字面量和符号引用，常量池中会有很多常量，每个常量则又是一张表，又代表了不同的常量，总而言之就是常量的汇集之处，数据量会很多。
- 访问标志

  用于标识这个```Class```是类还是接口，是否定义为public类型，是否定义为abstract类型，如果是类的话是否被声明为final等等。

- 类索引、父类索引与接口索引集合

  用于确定类的继承、实现关系。
  
  类索引和父类索引用两个u2类型的索引值，各自指向一个类型为CONSTANT_Class_info的类描述符常量，通过CONSTANT_Class_info类型的常量中的索引值可以找到定义在CONSTANT_Utf8_info类型的常量中的全限定名字符串，找到继承的父类。

  对于接口索引集合，因为可以实现多个接口，所以入口的第一项u2类型的数据为接口计数器（interfaces_count），表示索引表的容量。如果该类没有实现任何接口，则该计数器值为0，后面接口（interfaces）的索引表不再占用任何字节。

- 字段表集合

  field_count表示为字段的数量，而field_info则是表示字段的属性，比如被什么修饰，public、static、final、volatile和transient等等，以及字段数据类型（基本类型、对象、数组）字段名称等等。

- 方法表集合
  
  和上面一个原理，method_count为方法数量，method_info则是方法的各种属性。

- 属性表集合

   顾名思义，就是用来存储各种属性的地方，上面field_info和method_info中其实都有自己的属性表来存储属性，```Class```文件也有自己的属性表来存储属性。

---

>## 三、 Class文件的设计思路

从上面的介绍来看，会发现其实就是可以把```Class```文件理解为一种设计好的架构模式，定义了各种无符号数以及无符号数组成的表，来存储各种各样的数据，而Java虚拟机就依靠解析这些数据，来分析出代码到底该如何执行。

也因此```Class```文件有着严格的格式要求，每个字段常量的长度，每个字段常量的顺序都有着严格要求，但是响应的只要你符合格式，具体怎么实现虚拟机则完全不受影响，这样即保证了规范又保证了后续扩展开发的灵活性。

本质上来理解，可以把对```Class```文件的实现当做是和日常编写代码一样，只不过这里的目的是为了更好更合理的保存```Class```文件中的各种属性，然后由虚拟机的代码来执行。