## 一、分布式一致性协议
分布式系统有很多种保证一致性的协议，都有各自的优点和缺点。

### 1. 2PC(Two-Phase Commit)

2PC也就是二阶段提交，这种协议需要引入```协调者(Coordinator)```的概念，它的作用是根据所有其他节点的操作情况来最终决定事务是否成功。顾名思义，2PC会分为下面的两个阶段。

1. 阶段一：提交事务请求
   - 协调者发起一个事务提交请求，其它所有节点都会收到这个请求，协调者会等待所有节点的相应。
   - 所有参与的节点都会执行事务操作，记录到事务日志中，并且把事务操作结果发送给协调者。
   - 如果所有参与的节点都相应事务提交成功了，那表示可以执行事务提交，如果有一个节点响应失败或者响应超时，则不能执行事务提交，因此这一阶段也被称为投票阶段。

2. 阶段二：执行事务提交

   这一阶段是根据上面阶段一的投票结果来进行后续操作的，分别是执行提交事务和执行回滚事务。

   - 执行提交事务

     - 协调者向所有节点发送事务提交请求
     - 所有节点收到提交请求后会正式提交事务，然后释放锁定的资源
     - 提交完后返回Ack消息给协调者
     - 协调者收到所有节点返回的Ack消息，整个分布式事务算是彻底完成了提交
   - 执行回滚事务
     
     - 协调者向所有节点发送事务回滚请求
     - 所有节点收到回滚请求，利用事务日志回滚事务
     - 回滚完后返回Ack消息给协调者
     - 协调者收到所有节点返回的Ack消息，整个分布式事务算是彻底完成了回滚

3. 2PC协议总结
   
   2PC可以看做是一个强一致性的协议，因为按照这个模式，绝对不可能会出现数据不一致的问题，因为只要有一个失败则全部失败。

   - 优点

     原理简单，实现方便，大部分的数据库都是用2PC协议来实现分布式事务。

   - 缺点

     因为是强一致协议，无论是阶段一的投票还是阶段二的提交都是同步阻塞的，必须要等到所有的节点都完成操作。
     
     因为过于依赖协调者，如果中途协调者出现问题则会一直阻塞住。

     如果在阶段二发送提交请求的过程中，协调者在给所有节点发送的过程中崩溃了，只有一部分节点收到提交请求，就会产生数据不一致的问题。

     因为是同步阻塞，只要有一个节点在过程中出现问题，协调者只能等待到超时才能中断整个过程，没有其他办法获取到节点的状态。

---

### 2. 3PC(Three-Phase Commit)

3PC也就是三阶段提交，其实就是把二阶段提交中的阶段二拆成了两个步骤，分为了预提交和正式提交。

1. 阶段一：提交事务请求
   - 协调者发起一个事务提交请求，其它所有节点都会收到这个请求，协调者会等待所有节点的相应。
   - 所有参与的节点都会判断自身是否能够执行事务，并且返回响应信息给协调者。

2. 阶段二：执行事务预提交

   这一阶段是根据上面阶段一的投票结果来进行后续操作的，所有节点都响应通过则执行事务预提交，有节点超时或响应无法提交的则中断事务。

   - 执行预提交

     - 协调者向所有节点发送事务预提交请求，进入预提交状态
     - 所有节点收到预提交请求后会预提交事务，写入事务日志
     - 提交完后返回Ack消息给协调者
     - 协调者收到所有节点返回的Ack消息

   - 中断事务
     
     - 协调者向所有节点发送事务中断请求
     - 所有节点收到中断请求，中断事务

3. 阶段三：执行事务正式提交
   
   这一阶段的操作也是基于阶段二的操作结果，因此会有提交事务和中断事务两种操作，要注意的是如果该阶段协调者出问题了，参与事务的节点等待协调者超时后会直接提交事务。

   - 执行提交事务

     - 协调者向所有节点发送事务提交请求
     - 所有节点收到提交请求后会正式提交事务，然后释放锁定的资源
     - 提交完后返回Ack消息给协调者
     - 协调者收到所有节点返回的Ack消息，整个分布式事务算是彻底完成了提交
   - 中断事务
     
     - 协调者向所有节点发送中断事务请求
     - 所有节点收到中断事务请求，利用事务日志回滚事务，释放资源
     - 回滚完后返回Ack消息给协调者
     - 协调者收到所有节点返回的Ack消息，中断整个事务

4. 3PC协议总结

   3PC是基于2PC的一种升级优化，为了避免2PC中协调者出问题导致节点锁死的问题。

   - 优点
   
   避免了2PC中协调者出问题可能导致所有节点锁死的问题。

   - 缺点

   增加了步骤，使用起来复杂了很多。并且如果协调者在第二阶段崩溃了，有部分节点成功收到了预提交命令，然后执行成功了进行入到了阶段三，但是这个时候联系补上协调者，则节点会直接提交事务，导致数据不一致。