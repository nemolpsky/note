### Hystrix的作用和设计

Hystrix是Netflix的一个项目，官网上的介绍是一个在分布式环境中让你自己通过添加延迟和容错逻辑来控制各个分布式服务之间交互的类库。它提供了很多功能，比如限流，降级，熔断还有监控功能，在Feign中其实已经默认集成了Hystrix，只要配置好之后就可以使用它的降级功能，但是Hystrix的功能还很强大，设计架构也是专门为了处理分布式系统的一些问题，如果了解Hystrix所解决的问题和解决问题的方式可以更好的了解分布式架构。


---


#### 1. Hystrix所解决的问题

在分布式系统中，尤其是大型的分布式系统中，各种服务之间会有着很复杂的依赖关系，比如下面这张图就描绘了一个分布式系统内部的依赖关系，在用户看来只是一个请求，但是服务内部之间其实会有很多互相调用的。


![1](https://github.com/nemolpsky/note/raw/master/file/micro/hystrix/images/1.png)


再看下面这张图，描绘了如果其中有一个服务出问题会怎么样，所有依赖该服务的请求都会阻塞在这里，一直长时间等待响应，最后积压的数量多了，不仅仅会影响到整个服务器的性能，甚至连上游客户直接请求的tomcat的连接池可能都会占满，这也就是一个服务出现问题，导致所有的服务都受到影响。


![2](https://github.com/nemolpsky/note/raw/master/file/micro/hystrix/images/2.png)


这个时候可能你会疑惑，分布式系统不是都会保证高可用吗？举个例子，如果一个分布式系统中有30个服务，每个服务的可用性是99.99%，这已经算是很高的了，但是30个服务累加到一起按下面的公式计算下整个分布式系统的可用性，会发现直接跌到99.7%了，这也就是说如果一个分布式系统中的服务越多，那么最后总的宕机时间无形中就会提高，因为只要有一个出问题，可能就整个系统都会受到影响，这也就是为啥要设计Hystrix来解决这些问题了。

```
99.99^30 = 99.7% uptime
0.3% of 1 billion requests = 3,000,000 failures
2+ hours downtime/month even if all dependencies have excellent uptime.
```

---

#### 2. Hystrix如何解决这些问题

Hystrix中有两个类```HystrixCommand```和```HystrixObservableCommand```，Hystrix是利用这两个类包装执行所有的请求，这也是被称作命令模式的设计模式，这样做的目的是为了配合Hystrix中的隔离机制。

在Hystrix中有两种隔离方式，第一种是线程隔离，第二种是信号隔离，也就是计数器。其实很好理解，正常情况下，一个请求从tomcat进来，再到它调用别的服务，这两步操作都会在同一个线程中执行，所以如果最后调用别的服务这一步如果阻塞了那这个线程也就阻塞了，这个请求也就阻塞住了，也就造成tomcat的请求都阻塞在那里。但是Hystrix会把最后调用别的服务这一步放到另一个线程池中执行，阻塞的话也不会阻塞住当前tomcat请求的这个线程。下面这张图就描述了这个架构，可以发现每个服务都配置了一个线程池。


![3](https://github.com/nemolpsky/note/raw/master/file/micro/hystrix/images/3.png)


上面的命令模式和线程隔离就是Hystrix最核心的东西了，剩下的都是基于这个机制设计的，比如设计调用别的服务的超时时间，如果超过了则直接返回一个默认结果，这就是所谓的降级，如果一定时间内请求失败的数量超过阀值，则直接返回默认结果，也就是打开了熔断器。当然实际的设计会比较复杂，不过大致的概念是这些。