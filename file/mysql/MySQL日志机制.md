
## MySQL日志机制

MySQL主要有redolog、undolog和binlog三种日志机制，这三种日志各有区别，实现不同的功能。



### 一、redolog

用于记录事务执行，但是它记录的不是事务执行的语句，而是最终对物理数据页的修改，也就是二进制格式。它是按顺序追加写入，是InnoDB引擎才有。

整个redolog文件大小是固定的，所以写入是对文件进行循环写入，比如文件有4G大，写入数据超过4G时就会从头覆盖写入新的数据。


1. 刷盘机制

    因为redolog是一个磁盘文件，这就会设计落盘，磁盘写入相对来说是很耗费时间的，所以MySQL中有一个内存缓冲区(redolog buffer)，所有的事务操作都记录在缓冲区中，再写入到磁盘上。


    MySQL提供了一个参数，名为```innodb_flush_log_at_trx_commit ```，它可以控制缓冲区写入磁盘的机制。

    默认是1，也就是每次提交事务时都会触发缓冲区同步磁盘，这样会影响性能，但是能最大程度保证安全。

    0则是每秒写入一次缓存区并同步磁盘，2则是每次提交就写入缓存区，但是要每秒才同步一次磁盘，这两种都可能导致丢失那1秒的事务。


---

### 二、undolog

同样是只有InnoDB引擎才有，专门用于回滚操作。

1. 存储机制

    undo log的存储是分段存储的，存储在undolog segment中，undolog segment是物理文件，默认1M大。

    日志会记录每次事务id，变更类型 (insert、update、delete)和旧版本数据。

2. 回滚机制

    当需要回滚时就通过事务id查找旧版本数据，执行完回滚再把这条undolog记录标记失效。

---

### 三、 binlog

binlog不只是InnoDB引擎才有，它是MySQL中Server层的特性，所有引擎都可以使用。


1. 存储机制

   binlog日志存储的是执行的SQL语句，所以主从复制，数据恢复都可以利用binlog实现。

2. 刷盘机制

   取决于```sync_binlog```参数，5.8之前默认是0，5.8之后默认是1，而且5.8之后取消的N的设置。

   - 0，系统自己选择何时的时机刷盘，有可能丢失数据。
   - 1，每次事务提交前都刷盘
   - N，自己设置多少次事务才执行刷盘。

---

### 四、Redo log、Undo log 和 Binlog 区别和用途



| 特性 | Redo log | Undo log | Binlog |
|---|---|---|---|
| 类型 | 物理日志 | 逻辑日志 | 逻辑日志 |
| 记录内容 | 事务提交后的数据变更 | 事务开始前的状态 | 事务的原始逻辑 |
| 作用 | crash-safe(恢复数据库到崩溃前状态) | 事务回滚、MVCC | 主从复制、数据恢复 |
| 位置 | 内存、磁盘 | 内存、磁盘 | 磁盘 |
| 刷盘时机 | 事务提交后立即 | 事务开始时、回滚时 | 可配置 |


